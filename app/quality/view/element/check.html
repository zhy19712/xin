<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>丰宁BIM协同管理平台</title>
    <link rel="stylesheet" href="__COMMONCSS__/app.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/font-awesome/css/font-awesome.min.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/ztree/css/metroStyle/metroStyle.css" />
    <link rel="stylesheet" href="__PUBLIC__/easyui/easyui.css">
    <link rel="stylesheet" href="__PUBLIC__/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="__COMMONCSS__/admin.css" />
    <link rel="stylesheet" href="__COMMONCSS__/themes/blue.css" media="all" id="skin" kit-skin />
    <link rel="stylesheet" href="__PUBLIC__/datatables/css/jquery.dataTables.min.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/datatables/css/buttons.dataTables.min.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/webupload/webuploader.css" media="all" />
    <link rel="stylesheet" href="__COMMONCSS__/common.css" />
    <link rel="stylesheet" href="__COMMONJS__/datatable/datatable.css" />
    <link rel="stylesheet" href="__PUBLIC__/ztree/css/ztreequality/css/engineering.css">
    <script src="__PUBLIC__/jquery/jquery.min.js"></script>
    <script src="__PUBLIC__/layui/layui.js"></script>
    <script src="__PUBLIC__/ztree/js/jquery.ztree.all.min.js"></script>
    <script src="__PUBLIC__/easyui/jquery.easyui.min.js"></script>
    <script src="__PUBLIC__/datatables/js/jquery.dataTables.min.js"></script>
    <script src="__PUBLIC__/datatables/js/dataTables.buttons.min.js"></script>
    <script src="__PUBLIC__/datatables/js/dataTables.bootstrap.js"></script>
    <script src="__PUBLIC__/webupload/webuploader.min.js"></script>
    <script src="__COMMONJS__/array.js"></script>
    <script src="__COMMONJS__/ztree.js"></script>
    <script src="__COMMONJS__/datatable/datatables.js"></script>
    <script src="__COMMONJS__/nodes.js"></script>
    <script src="__COMMONJS__/upload.js"></script>
    <script src="__COMMONJS__/formlayer.js"></script>
    <script src="__COMMONJS__/download.js"></script>

</head>
<style type="text/css">
    #division .ztree,#unitWork .ztree{
        height: 100%;
        padding-bottom: 5px;
    }
    #division #ztree,#unitWork #ztreeUnit{
        margin-top: 0px;
    }
    /*.dataTables_wrapper, .tbcontainer,#tableContent .imgList,#tableContent #tableItem {*/
        /*display: none;*/
    /*}*/
    /*#tableContent #tableItem{*/
        /*display: none;*/
    /*}*/
    .dataTables_wrapper, .tbcontainer{
         display: block;
    }
    .imgList,.mybtn,.bitCodes{
        display: none;
    }
    #tableContent .mybtn i.fa:before,#tableContent .bitCodes i.fa:before,#tableContent .alldel i.fa:before,#tableContent .saveCheck i.fa:before{
        background: #00c0ef;
        color: #ffffff;
    }
    #tableContent .mybtn,#tableContent .bitCodes,#tableContent .alldel{
        float: right;
        background-color: #00c0ef;
    }
    #tableContent .mybtn,#tableContent .bitCodes,#tableContent .alldel{
        margin-right: 0.5%;
        margin-bottom: 5px;
        margin-top: .3%;
    }
    /*#tableContent table.dataTable.no-footer {*/
        /*border-top: 1px dotted;*/
    /*}*/
    #tableContent #tableItem_filter {
        float: left;
        margin-left: 1%;
    }
    #tableContent .select-color {
        background-color: #FDD5B5 !important;
    }
    #tableContent .dataTables_wrapper .dataTables_scroll {
        position: relative;
    }
    #tableContent .even, #unitWorkRightBottom .even {
        background-color: #ffffff;
    }
    #tableContent .odd, #unitWorkRightBottom .odd {
        background-color: #f9f9f9;
    }
    #tableContent .imgList {
        border-bottom: 1px dotted;
        padding: 3px 3px 5px;
    }
    #tableContent .imgList #homeWork {
        margin-right:3px;
    }
    #tableContent .imgList img {
        border-radius: 50%;
        margin-top: 3px;
    }
    #tableContent .imgListStyle {
        margin:5px 0px 3px 8px;
    }
    #tableContent .imgList a{
        cursor: pointer;
        font-style: inherit;
        /*color: #2213e9;*/
        color: gray;
        font-size: 13px;
        font-weight: 600;
    }
    #tableContent .imgList a:hover{
        color: #2213e9;
    }
    #tableContent .listName{
        padding: .5% 0;
        border-bottom: 1px dotted;
    }
    #tableContent .listName h3{
        font-weight: 800;
    }
    .layui-layer-content {
        padding-left: 5px;
        padding-right: 5px;
        margin-bottom:15px;
        padding-top: 0px;
    }
    .tabs-header, .tabs-tool {
        background-color: white;
        border-color:white;
    }
    .tabs li a.tabs-inner{
        background:white;
        border-color:#cecece;
    }
    .tabs-header, .tabs-scroller-left, .tabs-scroller-right, .tabs-tool, .tabs, .tabs-panels, .tabs li a.tabs-inner, .tabs li.tabs-selected a.tabs-inner, .tabs-header-bottom .tabs li.tabs-selected a.tabs-inner, .tabs-header-left .tabs li.tabs-selected a.tabs-inner, .tabs-header-right .tabs li.tabs-selected a.tabs-inner{
        border-color:#cecece;
    }
    #tableContent #nameCon{
        padding-left: 1.5%;
        margin-top: .5%;
        border-top: 1px dotted;
    }
    #tableContent .saveCheck{
        float: right;
        width: 5%;
        height: 25px;
        margin-right: .5%;
        margin-top: -.7%;
        text-align: center;
        border: none;
        background: #00c0ef;
        border-radius: 2px;
        color: #FFFFFF;
    }
    #tableContent .listName span{
        font-weight: 800;
    }
    #tableContent .result{
        margin-left: 150px;
        margin-top: 13px;
        position: relative;
    }
    #tableContent .result .layui-select-title,#tableContent #date{
        width: 360px;
    }
    #tableContent .result .layui-form-label{
        font-weight: bolder;
    }
    .layui-input[disabled], .layui-textarea[disabled], .layui-disabled, .layui-input[readonly], .layui-textarea[readonly], .layui-readonly {
        background: #FFFFFF !important;
    }
    /*#tableItem_wrapper{*/
        /*height: calc(100% - 230px);*/
    /*}*/
    #tableContent .dataTables_scroll,#unitWorkRightBottom .dataTables_scroll{
        height: 100%;
    }
    #tableContent .dataTables_scrollBody,#unitWorkRightBottom .dataTables_scrollBody{
        max-height: none!important;
        width: 100%;
        height: calc(100% - 39px)!important;
        border-bottom: none!important;
    }
    .dataTables_scrollHeadInner,#tableItem_wrapper table,#imageData_wrapper table, #implementation_wrapper table{
        width: 100% !important;
    }
    #implementation_wrapper, #imageData_wrapper{
        height: 100% !important;
    }

</style>
<body  class="easyui-layout">
<!--右边的工程划分-->
<div id="division" data-options="region:'west',title:'工程划分',split:true" style="width:240px;">
    <ul class="ztree" id="ztree"></ul>
</div>
<!--左边的单元工-->
<div id="unitWork" data-options="region:'center'" style="background:#fff;">
    <div class="easyui-layout" data-options="fit:true">
        <div id="unitWorkOut" data-options="region:'west',title:'单元工',split:true" style="width:210px;">
            <ul class="ztree" id="ztreeUnit"></ul>
        </div>
        <div id="unitWorkRight" data-options="region:'center'" style="background:#fff;">
            <div class="easyui-layout" data-options="fit:true">
                <div id="tableContent" data-options="region:'north',split:true" style="width:100%;height: 70%; position: relative;padding-top: 5px;">
                    <div class="listName" style="padding-left: 1.5%">
                        <span>验评结果</span>
                        <button class="saveCheck"><i class="fa fa-check"></i>&nbsp;保存</button>
                    </div>
                    <div class="result">
                        <form class="layui-form" action="">
                            <div class="layui-inline" style="margin-left: -3%">
                                <label class="layui-form-label">验评结果</label>
                                <div class="layui-input-inline">
                                    <select name="type" lay-filter="type">
                                        <option value="">-请选择-</option>
                                        <option value="0">未验评</option>
                                        <option value="1">优良</option>
                                        <option value="2">合格</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline" style="margin-left: 5%">
                                <label class="layui-form-label">验评日期</label>
                                <div class="layui-input-block">
                                    <input type="text" name="date" id="date" lay-verify="date" placeholder="请选择" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="listName" id="nameCon"><h3>控制点</h3></div>
                    <div class="imgList">
                        <span id="imgListLeft">
                            <a id="homeWork" class="imgListStyle" href="javascript:;"><img src="__WEBSITE__/elementimg/work.png" alt="工作">&nbsp;作业</a>
                        </span>
                        <span id="imgListRight">

                        </span>
                    </div>
                    <table id="tableItem" class="table cell-border" cellspacing="0"  width="100%">
                        <thead>
                            <tr>
                                <th>控制点编号</th>
                                <th>控制点名称</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="tbcontainer">
                        <div class="mark"></div>
                    </div>
                </div>
                <div id="unitWorkRightBottom" data-options="region:'center',split:true">
                    <div id="tt" class="easyui-tabs" style="width:100%;height: 100%;">
                        <div title="控制点执行情况" style="padding:3px 0 0 3px;">
                            <table id="implementation" class="table cell-border" cellspacing="0"  width="100%">
                                <thead>
                                    <tr>
                                        <th>文件名称</th>
                                        <th>负责人</th>
                                        <th>单位</th>
                                        <th>拍摄时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <div title="图像资料" style="padding:3px 3px 0 3px;">
                            <table id="imageData" class="table cell-border" cellspacing="0"  width="100%">
                                <thead>
                                    <tr>
                                        <th>图像名称</th>
                                        <th>上传人</th>
                                        <th>单位</th>
                                        <th>上传时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="form_container" style="display: none;"></div>
</body>
<script type="text/javascript">

    //组织结构表格
    var  tableItem, implementation, imageData, resultId;

    tableItem = $('#tableItem').DataTable({
        retrieve: true,
        processing: true,
        serverSide: true,
        iDisplayLength:1000,
        "scrollY": "200px",
        "scrollCollapse": "true",
        "paging": "false",
        ajax: {
            "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="
        },
        dom: 'rt',
        columns: [
            {
                name: "code"
            },
            {
                name: "name"
            },
            {
                name: "status"
            },
            {
                name: "id"
            }
        ],
        columnDefs: [
            {
                "targets":[0]
            },
            {
                "targets": [1]
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [2],
                "render": function (data, type, row) {
                    colorRed = data;
                    if(data == 0){
                        return '<span style="color:red">未执行</span>'
                    }
                    return '已执行'
                }
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [3],
                "render": function (data, type, row) {
                    var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='downConFile("+row[3]+")'><i title='下载' class='fa fa-download'></i></a>";
                    // html += "<a type='button' class='' style='margin-left: 5px;' onclick='printFile("+row[3]+")'><i title='打印' class='fa fa-print'></i></a>";
                    // html += "<a type='button' class='' style='margin-left: 5px;' onclick='delFile("+row[3]+")'><i title='删除' class='fa fa-trash'></i></a>";
                    return html;
                }
            }
        ],
        language: {
            "zeroRecords": "没有找到记录"
        }
    });

    //下载封装的方法
    function download(id,url) {
        $.ajax({
            url: url,
            type:"post",
            dataType: "json",
            data:{cpr_id:id},
            success: function (res) {
                if(res.code != 1){
                    layer.msg(res.msg);
                }else {
                    $("#form_container").empty();
                    var str = "";
                    str += ""
                        + "<iframe name=downloadFrame"+ id +" style='display:none;'></iframe>"
                        + "<form name=download"+id +" action="+ url +" method='get' target=downloadFrame"+ id + ">"
                        + "<span class='file_name' style='color: #000;'>"+str+"</span>"
                        + "<input class='file_url' style='display: none;' name='cpr_id' value="+ id +">"
                        + "<button type='submit' class=btn" + id +"></button>"
                        + "</form>"
                    $("#form_container").append(str);
                    $("#form_container").find(".btn" + id).click();
                }

            }
        })
    }

    //点击下载控制点模板
    function downConFile(id) {
        download(id,"{:url('quality/element/download')}");
    }


    var layer = layui.layer;
    //查询提交
    layui.use(['form', 'layedit', 'laydate', 'element', 'layer'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,laydate = layui.laydate;

        //日期
        laydate.render({
            elem: '#date'
        });

        //搜索
        form.on('select(type)', function(data){
            resultId = data.value;
        });
    });

    /*==========开始初始化工程划分树节点=============*/

    var selfid, nodeName, nodePid, zTreeObj, groupid, sNodes;

    var setting = {
        view: {
            showLine: true, //设置 zTree 是否显示节点之间的连线。
            selectedMulti: false //设置是否允许同时选中多个节点。
        },
        async: {
            enable: true,
            autoParam: ["pId"],
            type: "post",
            url: "{:url('quality/division/index')}",
            dataType: "json"
        },
        data: {
            simpleData: {
                enable: true,
                idkey: "id",
                pIdKey: "pId",
                rootPId: null
            }
        },
        callback: {
            onClick: this.nodeClick
        }
    };
    zTreeObj = $.fn.zTree.init($("#ztree"), setting, null);

    //点击获取路径
    function nodeClick(e, treeId, node) {
        selectData = "";
        sNodes = zTreeObj.getSelectedNodes()[0];//选中节点
        console.log(sNodes);
        selfid = zTreeObj.getSelectedNodes()[0].id;//当前id
        nodeName = zTreeObj.getSelectedNodes()[0].name;//当前name
        nodePid = zTreeObj.getSelectedNodes()[0].pId;//当前pid
        console.log(selfid + '---id');
        console.log(nodeName + '---name');
        console.log(nodePid + '---pid');
        var path = sNodes.name; //选中节点的名字
        node = sNodes.getParentNode();//获取父节点
        if (node) {
            //判断是否还有父节点
            while (node) {
                path = node.name + "-" + path;
                node = node.getParentNode();
            }
        } else {
            $(".layout-panel-center .panel-title").text(sNodes.name);
        }
        groupid = sNodes.pId ;//父节点的id

        $(".imgList").css("display","none");
        tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id=").load();
        implementation.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id=").load();
        imageData.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id=").load();
        clickId ='';
        conThisId ='';

        initData(selfid);//调用单元工
    }

    //全部展开
    $('#openNode').click(function () {
        zTreeObj.expandAll(true);
    });

    /*==========结束初始化 工程划分树节点 =============*/



    /**==========开始初始化 单元工树 =================*/

        //声明单元树的变量
    var selfidUnit ,nodeNameUnit ,nodePidUnit ,
        zTreeObjUnit ,groupidUnit ,sNodesUnit ,
        eTypeId ,controlPointId ,controlPointName ,
        conThisId ,selectData ,clickId;

    //名字拼接过滤方法
    function ajaxDataFilter(treeId, parentNode, responseData) {
        if (responseData) {
            for(var i =0; i < responseData.length; i++) {
                responseData[i].name = responseData[i].el_start + responseData[i].el_cease + responseData[i].pile_number + responseData[i].site;
                eTypeId = responseData[i].en_type;
            }
        }
        return responseData;
    };

    //初始化数据的方法
    function initData(selfid){
        var settingUnit = {
            view: {
                showLine: true, //设置 zTree 是否显示节点之间的连线。
                selectedMulti: false //设置是否允许同时选中多个节点。
            },
            async: {
                enable: true,
                autoParam: ["pid"],
                type: "post",
                url: "{:url('quality/element/getDivisionUnitTree')}?id="+selfid,
                dataType: "json",
                dataFilter: ajaxDataFilter
            },
            data: {
                simpleData: {
                    enable: true,
                    idkey: "id",
                    pIdKey: "pid",
                    rootPId: null
                }
            },
            callback: {
                onClick: this.nodeClickUnit
            }
        };
        zTreeObjUnit = $.fn.zTree.init($("#ztreeUnit"), settingUnit, null);
    }

    //点击获取路径
    function nodeClickUnit(e, treeId, node) {
        selectData = "";
        sNodesUnit = zTreeObjUnit.getSelectedNodes()[0];//选中节点
        console.log(sNodesUnit);
        selfidUnit = zTreeObjUnit.getSelectedNodes()[0].id;//当前id
        nodeNameUnit = zTreeObjUnit.getSelectedNodes()[0].name;//当前name
        nodePidUnit = zTreeObjUnit.getSelectedNodes()[0].pid;//当前pid
        console.log(selfidUnit + '---id');
        console.log(nodeNameUnit + '---name');
        console.log(nodePidUnit + '---pid');
        var path = sNodesUnit.name; //选中节点的名字
        node = sNodesUnit.getParentNode();//获取父节点
        if (node) {
            //判断是否还有父节点
            while (node) {
                path = node.name + "-" + path;
                node = node.getParentNode();
            }
        } else {
            // $(".layout-panel-center .panel-title").text(sNodesUnit.name);
        }
        groupidUnit = sNodesUnit.pId ;//父节点的id
        if(eTypeId){
            selfidName(eTypeId);
        }
        if(selfidUnit != undefined || selfidUnit != null){
            tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+selfidUnit).load();
        }
        $("#tableContent .imgList").css('display','block');
        $("#homeWork").css("color","#2213e9");
    }

    //获取控制点name
    function selfidName(id) {
        $.ajax({
            type: "post",
            url: "{:url('quality/element/getProcedures')}",
            data: {id: id},
            success: function (res) {
                // if(res.code == 1){
                console.log(res);
                var optionStrAfter = '';
                for(var i = 0;i<res.length;i++) {
                    $("#imgListRight").html('');
                    controlPointId = res[i].id;
                    controlPointName = res[i].name;
                    optionStrAfter +=
                        "<a href=\"javascript:;\"  class=\"imgListStyle\" onclick=\"clickConName("+ res[i].id +")\">" +
                            "<img class='imgNone' id='img"+i+"' src=\"__WEBSITE__/elementimg/right.png\" alt=\"箭头\">" +
                            "<img src=\"__WEBSITE__/elementimg/work.png\" alt=\"工作\">&nbsp;"+res[i].name+"<span style='display: none;'>"+res[i].id+"</span>" +
                        "</a>\n";
                };
                $("#imgListRight").append(optionStrAfter);
                if($(".imgNone").attr("id") == 'img0'){
                    $("#img0").css("display","none");
                }
                $("#tableItem_wrapper").css("height","calc(100% - "+$(".imgList").outerHeight()+"px - "+$(".result").outerHeight()+"px - 85px)");
                // }else if(res.code==0){
                //     layer.msg(res.msg);
                // }
            }
        })
    }

    /**==========结束初始化 单元工树 =============*/

    //点击置灰
    $(".imgList").on("click","a",function () {
        $(this).css("color","#2213e9").siblings("a").css("color","#CDCDCD");
        $("#homeWork").css("color","#CDCDCD");
    })

    //点击作业
    $(".imgList").on("click","#homeWork",function () {
        $(this).css("color","#2213e9").parent("span").next("span").children("a").css("color","#CDCDCD");
        tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+selfidUnit).load();
    });

    //点击工序控制点名字
    function clickConName(id) {
        conThisId = id;
        if(selfidUnit != undefined || selfidUnit != null && conThisId != undefined || conThisId != null){
            tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+selfidUnit+"&ma_division_id="+conThisId).load();
        }
        $("#tableContent .imgList").css('display','block');
        console.log(id);
    }

    //控制点里面的删除
    function delFile(id) {
        console.log(id);
        $.ajax({
            type: "post",
            url: "{:url('quality/element/delControlPointRelation')}",
            data: {id:id},
            success: function (res) {
                console.log(res);
                if(res.code ==1){
                    layer.msg("删除成功！")
                    tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+selfidUnit+"&ma_division_id="+conThisId).load();
                }
            }
        })
    }

    //点击行获取Id
    $("#tableItem").delegate("tbody tr","click",function (e) {
        if($(e.target).hasClass("dataTables_empty")){
            return;
        }
        $(this).addClass("select-color").siblings().removeClass("select-color");
        selectData = tableItem.row(".select-color").data();//获取选中行数据
        console.log(selectData[3]);
        clickId = selectData[3];
        if(clickId != undefined && clickId != null){
            implementation.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id="+clickId).load();
            imageData.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id="+clickId).load();
        }
    });

    /*============控制点情况开始==============*/
    //控制点情况结构表格
    implementation = $('#implementation').DataTable({
        retrieve: true,
        processing: true,
        serverSide: true,
        iDisplayLength:1000,
        "scrollY": "200px",
        "scrollCollapse": "true",
        "paging": "false",
        ajax: {
            "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id="
        },
        dom: 'tr',
        columns: [
            {
                name: "data_name"
            },
            {
                name: "nickname"
            },
            {
                name: "name"
            },
            {
                name: "create_time"
            },
            {
                name: "id"
            }
        ],
        columnDefs: [
            {
                "targets":[0]
            },
            {
                "targets": [1]
            },
            {
                "targets": [2]
            },
            {
                "targets": [3],
                "render": function (data, type, row) {
                    if (data == null || data == undefined || data == '') return '';
                    var time = new Date(data*1000);
                    var y = time.getFullYear();
                    var m = time.getMonth() + 1;
                    m = m < 10 ? '0' + m : m;
                    var d = time.getDate();
                    d = d < 10 ? ('0' + d) : d;
                    return y + '-' + m + '-' + d;
                }
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [4],
                "render": function (data, type, row) {
                    var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='conPicshow("+row[4]+")'><i title='预览' class='fa fa-search'></i></a>";
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='impDownFile("+row[4]+")'><i title='下载' class='fa fa-download'></i></a>";
                    // html += "<a type='button' class='' style='margin-left: 5px;' onclick='delFile("+row[4]+")'><i title='删除' class='fa fa-trash'></i></a>";
                    return html;
                }
            }
        ],
        language: {
            "zeroRecords": "没有找到记录"
        }
    });

    /*============控制点情况结束==============*/


    /*============图像资料开始==============*/
    //图像资料结构表格
    imageData = $('#imageData').DataTable({
        retrieve: true,
        processing: true,
        serverSide: true,
        iDisplayLength:1000,
        "scrollY": "200px",
        "scrollCollapse": "true",
        "paging": "false",
        ajax: {
            "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id="
        },
        dom: 'tr',
        columns: [
             {
                name: "data_name"
            },
            {
                name: "nickname"
            },
            {
                name: "name"
            },
            {
                name: "create_time"
            },
            {
                name: "id"
            }
        ],
        columnDefs: [
            {
                "targets":[0]
            },
            {
                "targets": [1]
            },
            {
                "targets": [2]
            },
            {
                "targets": [3],
                "render": function (data, type, row) {
                    if (data == null || data == undefined || data == '') return '';
                    var time = new Date(data*1000);
                    var y = time.getFullYear();
                    var m = time.getMonth() + 1;
                    m = m < 10 ? '0' + m : m;
                    var d = time.getDate();
                    d = d < 10 ? ('0' + d) : d;
                    return y + '-' + m + '-' + d;
                }
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [4],
                "render": function (data, type, row) {
                     var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='conPicshow("+row[4]+")'><i title='预览' class='fa fa-search'></i></a>";
                     html += "<a type='button' class='' style='margin-left: 5px;' onclick='impDownFile("+row[4]+")'><i title='下载' class='fa fa-download'></i></a>";
                     // html += "<a type='button' class='' style='margin-left: 5px;' onclick='delFile("+row[4]+")'><i title='删除' class='fa fa-trash'></i></a>";
                     return html;
                 }
            }
        ],
        language: {
            "zeroRecords": "没有找到记录"
        }
    });

    /*============图像资料结束==============*/

    //点击保存
    $("#tableContent").on("click",".saveCheck",function () {
        if($("#date").val() != '' && resultId != undefined){
            var data = tableItem.data();
            for(var i=0;i<data.length;i++){
                if(data[i][2] == 0 || data[i][2] == 1){
                    layer.confirm("有未执行的控制点，要继续验评吗？", function (index) {
                        saveInspectionLotEvaluate();
                        layer.close(index);
                    });
                }else if(data[i][2] == 1){
                    layer.confirm("点击确定保存验评！", function (index) {
                        saveInspectionLotEvaluate();
                        layer.close(index);
                    });
                }
            }
        }else{
            layer.alert("请选择验评条件")
        }
    });
    
    //保存验评调的接口
    function saveInspectionLotEvaluate() {
        $.ajax({
            type: "Post",
            url: "/quality/element/Evaluate",
            data: {
                Unit_id:selfidUnit,
                EvaluateResult:resultId,
                EvaluateDate:$("#date").val()
            },
            success: function (res) {
                if (res.code == 1) {
                    layer.alert("保存成功！");
                } else {
                    layer.alert("保存失败");
                }
            }
        });
    }

    //下载list封装的方法
    function downloadList(id,url) {
        $.ajax({
            url: url,
            type:"post",
            dataType: "json",
            data:{id:id},
            success: function (res) {
                if(res.code != 1){
                    layer.msg(res.msg);
                }else {
                    $("#form_container").empty();
                    var str = "";
                    str += ""
                        + "<iframe name=downloadFrame"+ id +" style='display:none;'></iframe>"
                        + "<form name=download"+id +" action="+ url +" method='get' target=downloadFrame"+ id + ">"
                        + "<span class='file_name' style='color: #000;'>"+str+"</span>"
                        + "<input class='file_url' style='display: none;' name='id' value="+ id +">"
                        + "<button type='submit' class=btn" + id +"></button>"
                        + "</form>"
                    $("#form_container").append(str);
                    $("#form_container").find(".btn" + id).click();
                }

            }
        })
    }

    //点击下面的列表的下载
    function impDownFile(id) {
        downloadList(id,"{:url('quality/Unitqualitymanage/relationDownload')}");
    }

    //预览
    function showPdf(id,url) {
        $.ajax({
            url: url,
            type: "post",
            data: {id:id},
            success: function (res) {
                console.log(res);
                if(res.code === 1){
                    var path = res.path;
                    if(res.path.split(".")[1]==="pdf"){
                        window.open("/static/public/web/viewer.html?file=../../../" + path,"_blank");
                    }else if(res.path.split(".")[1]==="png"||res.path.split(".")[1]==="jpg"||res.path.split(".")[1]==="jpeg"){
                        layer.photos({
                            photos: {
                                "title": "", //相册标题
                                "id": id, //相册id
                                "start": 0, //初始显示的图片序号，默认0
                                "data": [   //相册包含的图片，数组格式
                                    {
                                        "alt": "图片名",
                                        "pid": id, //图片id
                                        "src": "../../../"+res.path, //原图地址
                                        "thumb": "" //缩略图地址
                                    }
                                ]
                            }
                            ,anim: Math.floor(Math.random()*7) //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
                        });
                    }else{
                        layer.msg("不支持的文件格式");
                    }

                }else {
                    layer.msg(res.msg);
                }
            }
        })
    }

    //点击打印模板
    function conPicshow(id) {
        showPdf(id,"{:url('quality/Unitqualitymanage/relationPreview')}");
    }

    //打印
    function conPrint(id) {
        layer.msg('打印');
    }

</script>
</html>
