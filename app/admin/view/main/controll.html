<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>丰宁BIM协同管理平台</title>
    <link rel="stylesheet" href="__COMMONCSS__/app.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/font-awesome/css/font-awesome.min.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/ztree/css/metroStyle/metroStyle.css" />
    <link rel="stylesheet" href="__PUBLIC__/easyui/easyui.css">
    <link rel="stylesheet" href="__PUBLIC__/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="__COMMONCSS__/admin.css" />
    <link rel="stylesheet" href="__COMMONCSS__/themes/blue.css" media="all" id="skin" kit-skin />
    <link rel="stylesheet" href="__PUBLIC__/datatables/css/jquery.dataTables.min.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/datatables/css/buttons.dataTables.min.css" media="all" />
    <link rel="stylesheet" href="__PUBLIC__/webupload/webuploader.css" media="all" />
    <link rel="stylesheet" href="__COMMONCSS__/common.css" />
    <link rel="stylesheet" href="__COMMONJS__/datatable/datatable.css" />
    <link rel="stylesheet" href="__PUBLIC__/ztree/css/ztreequality/css/engineering.css">
    <script src="__PUBLIC__/jquery/jquery.min.js"></script>
    <script src="__PUBLIC__/layui/layui.js"></script>
    <script src="__PUBLIC__/ztree/js/jquery.ztree.all.min.js"></script>
    <script src="__PUBLIC__/easyui/jquery.easyui.min.js"></script>
    <script src="__PUBLIC__/datatables/js/jquery.dataTables.min.js"></script>
    <script src="__PUBLIC__/datatables/js/dataTables.buttons.min.js"></script>
    <script src="__PUBLIC__/datatables/js/dataTables.bootstrap.js"></script>
    <script src="__PUBLIC__/webupload/webuploader.min.js"></script>
    <script src="__COMMONJS__/array.js"></script>
    <script src="__COMMONJS__/ztree.js"></script>
    <script src="__COMMONJS__/datatable/datatables.js"></script>
    <script src="__COMMONJS__/nodes.js"></script>
    <script src="__COMMONJS__/upload.js"></script>
    <script src="__COMMONJS__/formlayer.js"></script>
    <script src="__COMMONJS__/download.js"></script>

</head>
<style type="text/css">
    #division .ztree,#unitWork .ztree{
        height: 100%;
        padding-bottom: 5px;
    }
    #division #ztree,#unitWork #ztreeUnit{
        margin-top: 0px;
    }
    .dataTables_wrapper{
        display: block;
    }
    #unitWorkRightBottom .mybtn i.fa:before,#unitWorkRightBottom .bitCodes i.fa:before,#unitWorkRightBottom .mybtnAdd i.fa:before,#unitWorkRightBottom .saveCheck i.fa:before{
        background: #00c0ef;
        color: #ffffff;
    }
    #unitWorkRightBottom .mybtn,#unitWorkRightBottom .bitCodes,#unitWorkRightBottom .mybtnAdd{
        position: absolute;
        right: 0;
        top: 0;
        color: #FFFFFF;
        width: 50px;
        text-align: center;
        border-radius: 50px;
        height: 25px;
        line-height: 26px;
        margin-top: 2px;
        background-color: #00c0ef;
        cursor: pointer;
    }
    #unitWorkRightBottom .bitCodes{
        right: 5%;
    }
    #unitWorkRightBottom .mybtn,#unitWorkRightBottom .bitCodes,#unitWorkRightBottom .mybtnAdd{
        margin-right: 0.5%;
        margin-bottom: 5px;
        margin-top: .25%;
    }
    #tableContent #tableItem_filter {
        float: left;
        margin-left: 1%;
    }
    .select-color {
        background-color: #FDD5B5 !important;
    }
    #tableContent .dataTables_wrapper .dataTables_scroll {
        position: relative;
        /*top: 15px;*/
        /*border-top: 1px dotted #cecece;*/
    }
    #tableContent #tableItem .even ,#implementationParent .even ,#imageDataParent .even ,#onlineFillParent .even {
        background-color: #ffffff;
    }
    #tableContent #tableItem .odd ,#implementationParent .odd ,#imageDataParent .odd ,#onlineFillParent .odd  {
        background-color: #f9f9f9;
    }
    #tableContent .imgList {
        /*border-top: 1px dotted;*/
        border-bottom: 1px dotted;
        padding: 5px 3px;
    }
    #tableContent .imgList #homeWork {
        margin-right:3px;
    }
    #tableContent .imgList img {
        border-radius: 50%;
        margin-top: 3px;
    }
    #tableContent .imgListStyle {
        margin:5px 0px 3px 8px;
    }
    #tableContent .imgList a{
        cursor: pointer;
        font-style: inherit;
        /*color: #2213e9;*/
        color: gray;
        font-size: 13px;
        font-weight: 600;
    }
    #tableContent .imgList a:hover{
        color: #2213e9;
    }
    #tableContent .listName{
        padding:  .5% 0;
        border-bottom: 1px dotted;
        /*margin-bottom: 5px;*/
    }
    #tableContent .listName h3{
        font-weight: 800;
    }
    .layui-layer-content {
        padding-left: 5px;
        padding-right: 5px;
        margin-bottom:15px;
        padding-top: 0px;
    }
    .tabs-header, .tabs-tool {
        background-color: white;
        border-color:white;
    }
    .tabs li a.tabs-inner{
        background:white;
        border-color:#cecece;
    }
    .tabs-header, .tabs-scroller-left, .tabs-scroller-right, .tabs-tool, .tabs, .tabs-panels, .tabs li a.tabs-inner, .tabs li.tabs-selected a.tabs-inner, .tabs-header-bottom .tabs li.tabs-selected a.tabs-inner, .tabs-header-left .tabs li.tabs-selected a.tabs-inner, .tabs-header-right .tabs li.tabs-selected a.tabs-inner{
        border-color:#cecece;
    }
    #tableContent #nameCon{
        padding-left: 1.5%;
        /*margin-top: .5%;*/
        /*border-top: 1px dotted;*/
    }
    #tableContent .saveCheck{
        float: right;
        width: 5%;
        height: 25px;
        margin-right: .5%;
        margin-top: -.7%;
        text-align: center;
        border: none;
        background: #00c0ef;
        border-radius: 2px;
        color: #FFFFFF;
    }
    #tableContent .listName span{
        font-weight: 800;
    }
    #tableContent .result{
        margin-left: 150px;
        margin-top: 13px;
        position: relative;
    }
    #tableContent .result .layui-select-title,#tableContent #date{
        width: 360px;
    }
    #tableContent .result .layui-form-label{
        font-weight: bolder;
    }
    .layui-input[disabled], .layui-textarea[disabled], .layui-disabled, .layui-input[readonly], .layui-textarea[readonly], .layui-readonly {
        background: #FFFFFF !important;
    }
    .mybtn,.mybtn1,.bitCodes{
           display: none;
       }
    #tableContent .dataTables_scroll,#unitWorkRightBottom .dataTables_scroll{
        height: 100%;
    }
    #tableContent .dataTables_scrollBody{
        max-height: none!important;
        width: 100%;
        height: calc(100% - 39px)!important;
        border-bottom: none!important;
    }
    #unitWorkRightBottom .dataTables_scrollBody{
        max-height: none!important;
        width: 100%;
        height: calc(100% - 39px)!important;
        border-bottom: none!important;
    }
    .dataTables_scrollHeadInner,#tableItem_wrapper table,#imageData_wrapper table, #implementation_wrapper table, #onlineFill_wrapper table{
        width: 100% !important;
    }
    #imageData_wrapper, #implementation_wrapper, #onlineFill_wrapper{
        height: 100% !important;
    }
    #onlineFillParent table.dataTable thead .sorting_asc {
        background-image: none !important;
    }
</style>
<body  class="easyui-layout">
<!--左边的单元工-->
<div id="unitWork" data-options="region:'center'" style="background:#fff;">
    <div class="easyui-layout" data-options="fit:true">
        <div id="unitWorkRight" data-options="region:'center'" style="background:#fff;">
            <div class="easyui-layout" data-options="fit:true">
                <div id="tableContent" data-options="region:'north',split:true" style="width:100%;height: 70%; position: relative;">
                    <div class="listName" id="nameCon"><h3>控制点</h3></div>
                    <div class="imgList">
                        <span id="imgListLeft">
                            <a id="homeWork" class="imgListStyle" href="javascript:;"><img src="__WEBSITE__/elementimg/work.png" alt="工作">&nbsp;作业</a>
                        </span>
                        <span id="imgListRight">

                        </span>
                    </div>
                    <table id="tableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                        <thead>
                            <tr>
                                <th>控制点编号</th>
                                <th>控制点名称</th>
                                <th>状态</th>
                                <th>操作</th>
                                <th style="display: none">参考流程</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="tbcontainer">
                        <div class="mark"></div>
                    </div>
                </div>
                <div id="unitWorkRightBottom" data-options="region:'center',split:true">
                    <div id="unitTab" class="easyui-tabs" style="width:100%;height: 100%;">
                        <div id="implementationParent" title="控制点执行情况" style="padding:3px 0 0 3px;">
                            <table id="implementation" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                <tr>
                                    <th>文件名称</th>
                                    <th>负责人</th>
                                    <th>单位</th>
                                    <th>拍摄时间</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                        <div id="imageDataParent" title="附件资料" style="padding:3px 3px 0 3px;">
                            <table id="imageData" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                <tr>
                                    <th>图像名称</th>
                                    <th>上传人</th>
                                    <th>单位</th>
                                    <th>上传时间</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                        <div id="onlineFillParent" title="在线填报" style="padding:3px 3px 0 3px;">
                            <table id="onlineFill" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                    <tr>
                                        <th>填报人</th>
                                        <th>填报日期</th>
                                        <th>当前审批人</th>
                                        <th>审批状态</th>
                                        <th>操作</th>
                                        <th style="display: none;">当前审批人Id</th>
                                        <th style="display: none;">当前审批人CurrentStep</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <div class="mybtn"><div id='test3'><i class='fa fa-upload'></i>&nbsp;上传</div></div>
                    <!--<div class="bitCodes" style="display: none"><div id='bit'><i class='fa fa-check-square-o'></i>&nbsp;选择</div></div>-->
                    <div class="mybtnAdd" style="display: none"><div id='addTest'><i class='fa fa-plus'></i>&nbsp;新增</div></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="form_container" style="display: none;"></div>
<div id="form_container_from" style="display: none;"></div>
<input type="hidden" id="userId" value=''>
<input type="hidden" id="resVal" value="">
<input type="hidden" id="curStepVal" value="">
</body>
<script type="text/javascript">
    var unitEnginNoId = document.cookie.split(';')[0].split('=')[1];    //单元工程段号编号
    var divisionId = document.cookie.split(';')[1].split('=')[1];    //工程划分-单位工程编号
    //组织结构表格
    var  tableItem, implementation, imageData, onlineFill, type=1, gridHeight, resources;

    tableItem = $('#tableItem').DataTable({
        retrieve: true,
        processing: true,
        serverSide: true,
        iDisplayLength:1000,
        "scrollY": "200px",
        "scrollCollapse": "true",
        "paging": "false",
        ajax: {
            "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="
        },
        dom: 'rt',
        columns: [
            {
                name: "code"
            },
            {
                name: "name"
            },
            {
                name: "status"
            },
            {
                name: "id"
            },
            {
                name: "remark"
            }
        ],
        columnDefs: [
            {
                "targets":[0]
            },
            {
                "targets": [1]
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [2],
                "render": function (data, type, row) {
                    if(data == 0){
                        return '<span style="color:red">未执行</span>'
                    }
                    return '已执行'
                }
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [3],
                "render": function (data, type, row) {
                    var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='downConFile("+row[3]+")'><i title='下载' class='fa fa-download'></i></a>";
                    // html += "<a type='button' class='' style='margin-left: 5px;' onclick='printFile("+row[3]+")'><i title='打印' class='fa fa-print'></i></a>";
                    // html += "<a type='button' class='' style='margin-left: 5px;' onclick='printConFile("+row[3]+")'><i title='打印' class='fa fa-print'></i></a>";
                    return html;
                }
            },
            {
                "targets": [4],
                "searchable": false,
                "visible": false
            },
        ],
        language: {
            "zeroRecords": "没有找到记录"
        }
    });

    //查询提交
    var layer = layui.layer;
    layui.use(['form', 'layedit', 'laydate', 'element', 'layer'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,laydate = layui.laydate;
    });

    var rowId;    //表行id
    var conThisId; //工序id
    $.ajax({
        type: "post",
        url: "{:url('quality/element/getProcedures')}",
        data: {id: unitEnginNoId},
        success: function (res) {
            console.log(res);
            var optionStrAfter = '';
            for(var i = 0;i<res.length;i++) {
                $("#imgListRight").html('');
                controlPointId = res[i].id;
                controlPointName = res[i].name;
                optionStrAfter +=
                    '<a href="javascript:;"  class="imgListStyle" onclick="clickConName(controlPointId)">' +
                    '<img class="imgNone" id="img'+ i +'" src="__WEBSITE__/elementimg/right.png" alt="箭头">' +
                    '<img src="__WEBSITE__/elementimg/work.png" alt="工作">'+ controlPointName+'<span style="display: none;">"+ controlPointId +"</span>' +
                    '</a>';
            };
            $("#imgListRight").append(optionStrAfter);
            if($(".imgNone").attr("id") == 'img0'){
                $("#img0").css("display","none");
            }

            $("#tableItem_wrapper").css("height","calc(100% - "+$(".imgList").outerHeight()+"px - 40px)");
        }
    })

    //点击置灰
    $(".imgList").on("click","a",function () {
        $(this).css("color","#2213e9").siblings("a").css("color","#CDCDCD");
        $("#homeWork").css("color","#CDCDCD");
    });

    var flag = true;
    //点击作业
    $(".imgList").on("click","#homeWork",function () {
        $(".bitCodes").css("display","none");
        $(".mybtn").css("display","none");
        $(".mybtnAdd").css("display","none");
        $(this).css("color","#2213e9").parent("span").next("span").children("a").css("color","#CDCDCD");
        tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+divisionId).load();
        flag = true;
    });

    //点击工序控制点名字
    function clickConName(id) {
        rowId ='';
        conThisId ='';
        console.log(conThisId);
        conThisId = id;
        console.log(conThisId);
        if(divisionId != undefined || divisionId != null && conThisId != undefined || conThisId != null){
            tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+divisionId+"&ma_division_id="+conThisId).load();
        }
        $("#tableContent .imgList").css('display','block');
        console.log(id + " 控制点工序 conThisId");
        if(rowId =='' || conThisId == '') {
            $(".bitCodes").css("display","none");
            $(".mybtn").css("display","none");
            $(".mybtnAdd").css("display","none");
            implementation.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id=").load();
            imageData.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id=").load();
            onlineFill = $("#onlineFill").dataTable().fnDestroy(true);
            $('#onlineFillParent').html("<table id=\"onlineFill\" class=\"table table-striped table-bordered\" cellspacing=\"0\"  width=\"100%\">\n" +
                "                                <thead>\n" +
                "                                    <tr style='text-align: center'>\n" +
                "                                        <th>填报人</th>\n" +
                "                                        <th>填报日期</th>\n" +
                "                                        <th>当前审批人</th>\n" +
                "                                        <th>审批状态</th>\n" +
                "                                        <th>操作</th>\n" +
                "                                        <th style=\"display: none;\">当前审批人Id</th>\n" +
                "                                    </tr>\n" +
                "                                </thead>\n" +
                "                            </table>");
        }
    }

    //下载封装的方法
    function download(id,url) {
        $.ajax({
            url: url,
            type:"post",
            dataType: "json",
            data:{cpr_id:id},
            success: function (res) {
                if(res.code != 1){
                    layer.msg(res.msg);
                }else {
                    $("#form_container").empty();
                    var str = "";
                    str += ""
                        + "<iframe name=downloadFrame"+ id +" style='display:none;'></iframe>"
                        + "<form name=download"+id +" action="+ url +" method='get' target=downloadFrame"+ id + ">"
                        + "<span class='file_name' style='color: #000;'>"+str+"</span>"
                        + "<input class='file_url' style='display: none;' name='cpr_id' value="+ id +">"
                        + "<button type='submit' class=btn" + id +"></button>"
                        + "</form>"
                    $("#form_container").append(str);
                    $("#form_container").find(".btn" + id).click();
                }

            }
        })
    }

    //点击下载控制点模板
    function downConFile(id) {
        download(id,"{:url('quality/element/download')}");
    }

    //下载list封装的方法
    function downloadList(id,url) {
        $.ajax({
            url: url,
            type:"post",
            dataType: "json",
            data:{id:id},
            success: function (res) {
                if(res.code != 1){
                    layer.msg(res.msg);
                }else {
                    $("#form_container").empty();
                    var str = "";
                    str += ""
                        + "<iframe name=downloadFrame"+ id +" style='display:none;'></iframe>"
                        + "<form name=download"+id +" action="+ url +" method='get' target=downloadFrame"+ id + ">"
                        + "<span class='file_name' style='color: #000;'>"+str+"</span>"
                        + "<input class='file_url' style='display: none;' name='id' value="+ id +">"
                        + "<button type='submit' class=btn" + id +"></button>"
                        + "</form>"
                    $("#form_container").append(str);
                    $("#form_container").find(".btn" + id).click();
                }

            }
        })
    }

    //点击下面的列表的下载
    function downConFileImp(id) {
        downloadList(id,"{:url('quality/Unitqualitymanage/relationDownload')}");
    }

    //点击下面的列表的下载
    function downConFileData(id) {
        downloadList(id,"{:url('quality/Unitqualitymanage/relationDownload')}");
    }

    //预览
    function showPdf(id,url) {
        $.ajax({
            url: url,
            type: "post",
            data: {id:id},
            success: function (res) {
                console.log(res);
                if(res.code === 1){
                    var path = res.path;
                    if(res.path.split(".")[1]==="pdf"){
                        window.open("/static/public/web/viewer.html?file=../../../" + path,"_blank");
                    }else if(res.path.split(".")[1]==="png"||res.path.split(".")[1]==="jpg"||res.path.split(".")[1]==="jpeg"){
                        layer.photos({
                            photos: {
                                "title": "", //相册标题
                                "id": id, //相册id
                                "start": 0, //初始显示的图片序号，默认0
                                "data": [   //相册包含的图片，数组格式
                                    {
                                        "alt": "图片名",
                                        "pid": id, //图片id
                                        "src": "../../../"+res.path, //原图地址
                                        "thumb": "" //缩略图地址
                                    }
                                ]
                            }
                            ,anim: Math.floor(Math.random()*7) //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
                        });
                    }else{
                        layer.msg("不支持的文件格式");
                    }

                }else {
                    layer.msg(res.msg);
                }
            }
        })
    }

    //点击打印模板
    function printConFile(id) {
        showPdf(id,"{:url('quality/Unitqualitymanage/relationPreview')}");
    }

    //删除封装的方法
    function delData(id,url) {
        layer.confirm('是否删除该数据?', function(index){
            $.ajax({
                type: "post",
                url: url,
                data: {id:id},
                success: function (res) {
                    console.log(res);
                    if(res.code ==1){
                        layer.msg("删除成功！");
                        tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+divisionId+"&ma_division_id="+conThisId).load();
                        implementation.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id="+rowId).load();
                        imageData.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id="+rowId).load();
                    }else if(res.code !=1){
                        layer.msg('返回数据错误！')
                    }
                }
            })
            layer.close(index);
        });
    }

    //控制点执行情况、附件资料的删除
    function delFile(id) {
        console.log(id);
        delData(id,"{:url('quality/Unitqualitymanage/relationDel')}");
    }

    //点击行获取Id
    $("#tableItem").delegate("tbody tr","click",function (e) {
        if($(e.target).hasClass("dataTables_empty")){
            return;
        }
        $(this).addClass("select-color").siblings().removeClass("select-color");
        selectData = tableItem.row(".select-color").data();//获取选中行数据
        console.log(selectData[3] +" ------控制点 rowId");
        rowId = selectData[3];
        resources = selectData[4];

        if(rowId != undefined && rowId != null){
            implementation.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id="+rowId).load();
            imageData.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id="+rowId).load();
            funOnLine(divisionId,conThisId,rowId)
            onlineFill.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId).load();
        }
        $(".bitCodes").css("display","none");
        $(".mybtn").css("display","none");
        $(".mybtnAdd").css("display","none");
        // if((conThisId != undefined && rowId != undefined) || (conThisId != null && rowId != null)){
        //     $(".mybtn").css("display","block");
        // }
        if($(".tabs-selected a span:first-child").html() === "控制点执行情况"){
            $(".mybtn").css("display","block");
        }else if($(".tabs-selected a span:first-child").html() === "附件资料"){
            $(".bitCodes").css("display","block");
            $(".mybtn").css("display","block");
        }else if($(".tabs-selected a span:first-child").html() === "在线填报"){
            $(".mybtnAdd").css("display", "block");
            $(".mybtn").css("display", "none");
        }
        //向提交页面之前放置值
        $("#resVal").val(resources);
    });

    //easyui点击显示选择
    $('#unitTab').tabs({
        border:false,
        onSelect:function(title,index){
            if(title === "控制点执行情况"){
                // if((conThisId != undefined && rowId != undefined) || (conThisId != null && rowId != null)){
                // if((rowId != null || rowId != undefined) && (conThisId != null || conThisId != undefined)){
                if(rowId && conThisId || flag == true && rowId){
                    $(".mybtn").css("display","block");
                }else if(rowId ==''|| conThisId == '') {
                    $(".mybtn").css("display","none");
                }
            }else if(title != "控制点执行情况"){
                $(".mybtn").css("display","none");
            }

            if(title === "附件资料"){
                if(rowId && conThisId || flag == true && rowId){
                    $(".bitCodes").css("display","block");
                    $(".mybtn").css("display","block");
                }else if(rowId ==''|| conThisId == '') {
                    $(".bitCodes").css("display","none");
                }
            }else if(title != "附件资料"){
                $(".bitCodes").css("display","none");
            }

            if(title === "在线填报"){
                if(rowId && conThisId || flag == true && rowId){
                    $(".mybtnAdd").css("display", "block");
                    $(".mybtn").css("display", "none");
                    console.log(rowId)
                    console.log(conThisId)
                }else if(rowId == undefined || rowId == null){
                    layer.msg("请选择控制点!")
                }else if(rowId == '' || conThisId == ''){
                    $(".mybtnAdd").css("display","none");
                }
            }else if(title != "在线填报"){
                $(".mybtnAdd").css("display","none");
            }
        }
    });

    //获取高度自适应
    function outerHeight() {
        gridHeight = parseInt($("#unitWorkRight").height() - $("#tableContent").height() - 49);
        $("#implementation_wrapper").css("height",gridHeight+"px");
    }


    /*============控制点情况开始==============*/
    //控制点情况结构表格
    implementation = $('#implementation').DataTable({
        retrieve: true,
        processing: true,
        serverSide: true,
        iDisplayLength:1000,
        "scrollY": "true",
        "scrollCollapse": "true",
        "paging": "false",
        ajax: {
            "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id="
        },
        dom:'rt',
        columns: [
            {
                name: "data_name"
            },
            {
                name: "nickname"
            },
            {
                name: "name"
            },
            {
                name: "create_time"
            },
            {
                name: "id"
            }
        ],
        columnDefs: [
            {
                "targets":[0]
            },
            {
                "targets": [1]
            },
            {
                "targets": [2]
            },
            {
                "targets": [3],
                "render": function (data, type, row) {
                    if (data == null || data == undefined || data == '') return '';
                    var time = new Date(data*1000);
                    var y = time.getFullYear();
                    var m = time.getMonth() + 1;
                    m = m < 10 ? '0' + m : m;
                    var d = time.getDate();
                    d = d < 10 ? ('0' + d) : d;
                    return y + '-' + m + '-' + d;
                }
            },
            {
                "searchable": false,
                "orderable": false,
                "targets": [4],
                "render": function (data, type, row) {
                    var a = data;
                    var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='printConFile("+row[4]+")'><i title='预览' class='fa fa-search'></i></a>";
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='downConFileImp("+row[4]+")'><i title='下载' class='fa fa-download'></i></a>";
                    html += "<a type='button' class='' style='margin-left: 5px;' onclick='delFile("+row[4]+")'><i title='删除' class='fa fa-trash'></i></a>";
                    return html;
                }
            }
        ],
        language: {
            "zeroRecords": "没有找到记录",
        },
        "fnDrawCallback":function(obj){
            outerHeight();
        }
    });

    //上传点击
    layui.use(['element', "layer", 'form', 'upload'], function () {
        var $ = layui.jquery
            , element = layui.element //Tab的切换功能，切换事件监听等，需要依赖element模块
            , upload = layui.upload;

        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;
            upload.render({
                elem: '#test3',
                url: "{:url('admin/common/upload?module=quality&use=element')}",
                // exts: 'doc|docx|pdf|png|jpg|xls',
                accept:"file",
                size:8192,
                before: function(obj){
                    obj.preview(function(index, file, result){
                        uploadName = file.name;
                        console.log(file.name);//获取文件名，result就是base64
                    })
                },
                done: function(res){
                    if($(".tabs-selected a span:first-child").html() === "附件资料"){
                        type=2;
                    }
                    console.log(res)
                    if(res.code == 2){
                        uploadId = res.id;

                        $.ajax({
                            url:"{:url('element/addExecution')}",
                            data:{
                                att_id:uploadId,
                                filename: uploadName, //名称
                                cpr_id:rowId,
                                type:type
                            },
                            type:'post',
                            success:function(res) {
                                console.log(res)
                                if(res.code == 1) {
                                    implementation.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=1&cpr_id="+rowId).load();
                                    imageData.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id="+rowId).load();
                                    tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+divisionId+"&ma_division_id="+conThisId).load();
                                } else {
                                    layer.msg('获取数据失败！');
                                }
                            }
                        })
                        layer.msg("上传成功！",{time:1500})
                    }else{
                        layer.msg("上传失败！",{time:1500})
                    }
                },
            });
    });

    /*============控制点情况结束==============*/



    /*============图像资料开始==============*/
    //图像资料结构表格
    imageData = $('#imageData').DataTable({
         retrieve: true,
         processing: true,
         serverSide: true,
         iDisplayLength:1000,
         "scrollY": "200px",
         "scrollCollapse": "true",
         "paging": "false",
         ajax: {
             "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_upload&type=2&cpr_id="
         },
         dom:'rt',
         columns: [
             {
                 name: "data_name"
             },
             {
                 name: "nickname"
             },
             {
                 name: "name"
             },
             {
                 name: "create_time"
             },
             {
                 name: "id"
             }
         ],
         columnDefs: [
             {
                 "targets":[0]
             },
             {
                 "targets": [1]
             },
             {
                 "targets": [2]
             },
             {
                 "targets": [3],
                 "render": function (data, type, row) {
                     if (data == null || data == undefined || data == '') return '';
                     var time = new Date(data*1000);
                     var y = time.getFullYear();
                     var m = time.getMonth() + 1;
                     m = m < 10 ? '0' + m : m;
                     var d = time.getDate();
                     d = d < 10 ? ('0' + d) : d;
                     return y + '-' + m + '-' + d;
                 }
             },
             {
                 "searchable": false,
                 "orderable": false,
                 "targets": [4],
                 "render": function (data, type, row) {
                     var html = "<a type='button' href='javasrcipt:;' class='' style='margin-left: 5px;' onclick='printConFile("+row[4]+")'><i title='预览' class='fa fa-search'></i></a>";
                     html += "<a type='button' class='' style='margin-left: 5px;' onclick='downConFileData("+row[4]+")'><i title='下载' class='fa fa-download'></i></a>";
                     html += "<a type='button' class='' style='margin-left: 5px;' onclick='delFile("+row[4]+")'><i title='删除' class='fa fa-trash'></i></a>";
                     return html;
                 }
             }
         ],
         language: {
             "zeroRecords": "没有找到记录"
         }
    });
    /*============图像资料结束==============*/



    /*============在线填报开始==============*/

    var isView = false;
    var reList = true ;

    //在线填报结构表格
    function funOnLine(divisionId,conThisId,rowId){
        onlineFill = $('#onlineFill').DataTable({
             retrieve: true,
             processing: true,
             serverSide: true,
             iDisplayLength:1000,
             "scrollY": "200px",
             "scrollCollapse": "true",
             "paging": "false",
             ajax: {
                 "url": "{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId
             },
             dom: 'tr',
             columns: [
                 {
                     name: "nickname"
                 },
                 {
                     name: "create_time"
                 },
                 {
                     name: "currentname"
                 },
                 {
                     name: "approvestatus"
                 },
                 {
                     name: "id"
                 },
                 {
                     name: "CurrentApproverId"
                 },
                 {
                     name: "CurrentStep"
                 }
             ],
             columnDefs: [
                 {
                     "targets":[0],
                     "searchable": false,
                     "orderable": false
                 },
                 {
                     "targets": [1],
                     "searchable": false,
                     "orderable": false,
                     "render": function (data, type, row) {
                         if (data == null || data == undefined || data == '') return '';
                         var time = new Date(data*1000);
                         var y = time.getFullYear();
                         var M = time.getMonth() + 1;
                         M = M < 10 ? '0' + M : M;
                         var d = time.getDate();
                         d = d < 10 ? ('0' + d) : d;
                         var h = time.getHours();
                         h = h < 10 ? '0' + h : h;
                         var m = time.getMinutes();
                         m = m < 10 ? '0' + m : m;
                         var s = time.getSeconds();
                         s = s < 10 ? '0' + s : s;
                         return y + '-' + M + '-' + d +' '+ h + ':' + m + ':' + s;
                     }
                 },
                 {
                     "targets": [2],
                     "searchable": false,
                     "orderable": false
                 },
                 {
                     "targets": [3],
                     "searchable": false,
                     "orderable": false,
                     "render": function (data, type, row) {
                         if (data === 0) {
                             return "待提交"
                         }
                         if (data === 1) {
                             return "待审批"
                         }
                         if (data === 2) {
                             return "已审批"
                         }
                         if (data === -1) {
                             return "被退回"
                         }
                     }
                 },
                 {
                     "searchable": false,
                     "orderable": false,
                     "targets": [4],
                     "render": function (data, type, row) {
                         // console.log(row);
                         console.log(row[5]+"当前审批人Id");
                         console.log($("#userId").val() + "当前登录人Id");
                         var html = "";
                         html += "<a title='查看' onclick='seeOnLine("+row[4]+")'><i class='fa fa fa-search'></i></a>";
                         if (row[3] === 0) {
                             html += "<a title='编辑' onclick='editOnLine("+row[4]+","+row[6]+")'><i class='fa fa-pencil'></i></a>";
                             html += "<a title='删除' onclick='delOnLine("+row[4]+")'><i class='fa fa fa-trash'></i></a>";
                             html += "<a title='提交' onclick='submitOnLine("+row[4]+")'><i class='fa fa fa-check-square-o'></i></a>";
                         }
                         else if (row[3] === 1 && row[5] == $("#userId").val()) {
                             var str = JSON.stringify(row[2]);
                             html += "<a title='编辑' onclick='editOnLine ("+row[4]+","+row[6]+")'><i class='fa fa fa-pencil'></i></a>";
                             html += "<a title='审批' onclick='approve("+row[4]+","+str+","+row[6]+")'><i class='fa fa fa-pencil-square-o'></i></a>";
                             html += "<a title='审批历史' onclick='historyOnLine("+row[4]+","+row[6]+")'><i class='fa fa fa-file-text'></i></a>";
                         }
                         else if (row[3] === 2) {
                             html += "<a title='审批历史' onclick='historyOnLine("+row[4]+","+row[6]+")'><i class='fa fa fa-file-text'></i></a>";
                             html += "<a title='下载' onclick='downOnLine("+row[4]+")'><i class='fa fa fa-download'></i></a>";
                         }
                         else if (row[3] === -1 && row[5] == $("#userId").val()) {
                             html += "<a title='提交' onclick='submitOnLine("+row[4]+")'><i class='fa fa fa-check-square-o'></i></a>";
                             html += "<a title='编辑' onclick='editOnLine("+row[4]+","+row[6]+")'><i class='fa fa fa-pencil'></i></a>";
                             html += "<a title='删除' onclick='delOnLine("+row[4]+")'><i class='fa fa fa-trash'></i></a>";
                             html += "<a title='审批历史' onclick='historyOnLine("+row[4]+","+row[6]+")'><i class='fa fa fa-file-text'></i></a>";
                         }
                         else html += "<a title='审批历史' onclick='historyOnLine("+row[4]+","+row[6]+")'><i class='fa fa fa-file-text'></i></a>";
                         return html;

                     }
                 },
                 {
                     "targets": [5],
                     "visible": false,
                     "searchable": false,
                     "orderable": false
                 },
                 {
                     "targets": [6],
                     "visible": false,
                     "searchable": false,
                     "orderable": false
                 }
             ],
             language: {
                 "zeroRecords": "没有找到记录"
             }
        });
    }

    //在线填报-新增
    $("#unitWorkRightBottom").on("click",".mybtnAdd",function () {
        console.log(rowId);
        layer.open({
            type: 2,
            title: '在线填报',
            shadeClose: true,
            area: ['980px', '90%'],
            content: '{:url("quality/Qualityform/edit")}?cpr_id='+ rowId + '&currentStep=0&isView=false',
            end:function () {
                onlineFill.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId).load();
            }
        });
    });

    //在线填报-查看
    function seeOnLine(id) {
        console.log(rowId);
        layer.open({
            type: 2,
            title: '在线填报',
            shadeClose: true,
            area: ['980px', '90%'],
            content: '{:url("quality/Qualityform/edit")}?cpr_id='+ rowId + '&id='+ id +'&currentStep=0&isView=True'
        });
    }

    //在线填报-编辑
    function editOnLine(id,step) {
        console.log(rowId);
        isView = true;
        layer.open({
            type: 2,
            title: '在线填报',
            shadeClose: true,
            area: ['980px', '90%'],
            content: '{:url("quality/Qualityform/edit")}?cpr_id='+ rowId + '&id='+ id +'&currentStep=' + step,
            end:function () {
                onlineFill.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId).load();
            }
        });
    }

    //在线填报-删除
    function delOnLine(id) {
        layer.confirm("你将删除该数据，是否确认删除？", function () {
            $.ajax({
                url: "{:url('quality/Qualityform/delForm')}",
                type: "post",
                data: {id: id},
                success: function (res) {
                    if (res.code === 1) {
                        layer.msg("删除数据成功！", {time: 1500, shade: 0.1});
                        onlineFill.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId).load();
                    }
                }
            });
        });
        console.log(id)
    }

    //在线填报-提交审批
    function submitOnLine(id) {
        $.ajax({
            url: "{:url('approve/Approve/CheckBeforeSubmitOrApprove')}",
            type: "post",
            data: {
                dataId:id,
                dataType:"app\\quality\\model\\QualityFormInfoModel",
                currentStep:0
            },
            success: function (res) {
                console.log(res);
                if(res == ""){
                    layer.open({
                        type: 2,
                        title: '提交审批',
                        shadeClose: true,
                        area: ['980px', '90%'],
                        content: '{:url("approve/approve/submit")}?dataId='+ id + '&dataType=app\\quality\\model\\QualityFormInfoModel',
                        end:function () {
                            funOnLine(divisionId,conThisId,rowId);
                            onlineFill.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId).load();
                        }
                    });
                }else if(res != ''){
                    layer.alert(res);
                }
            },
            error:function () {
                alert("获取数据完整性检测异常")
            }
        });
        console.log(id)
    }

    //在线填报-流程审批
    function approve(id,app,step) {
        console.log(app);
        $.ajax({
            url: "{:url('approve/Approve/CheckBeforeSubmitOrApprove')}",
            type: "post",
            data: {
                dataId:id,
                dataType:"app\\quality\\model\\QualityFormInfoModel",
                currentStep:step
            },
            success: function (res) {
                console.log(res);
                if(res == ""){
                    layer.open({
                        type: 2,
                        title: '流程审批',
                        shadeClose: true,
                        area: ['980px', '90%'],
                        content: '{:url("approve/approve/Approve")}?dataId='+ id + '&dataType=app\\quality\\model\\QualityFormInfoModel',
                        success: function(layero, index){
                            var body = layer.getChildFrame('body', index);
                            body.find("#conCode").val(app);
                            body.find("#dataId").val(id);
                            body.find("#dataType").val('app\\quality\\model\\QualityFormInfoModel');
                        },
                        end:function () {
                            funOnLine(divisionId,conThisId,rowId);
                            onlineFill.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_form_info&DivisionId="+divisionId+"&ProcedureId="+conThisId+"&cpr_id="+rowId).load();
                        }
                    });
                }else if(res != ''){
                    layer.alert(res);
                }
            },
            error:function () {
                alert("获取数据完整性检测异常")
            }
        });
        console.log(id);
    }

    //在线填报-审批历史
    function historyOnLine(id,curStep) {
        console.log(curStep)
        //向提交页面之前放置值
        $("#curStepVal").val(curStep);
        console.log($("#curStepVal").val())
        console.log(rowId);
        layer.open({
            type: 2,
            title: '审批历史',
            shadeClose: true,
            area: ['980px', '90%'],
            content: '{:url("approve/approve/ApproveHistory")}?dataId='+ id + '&dataType=app\\quality\\model\\QualityFormInfoModel',
            // end:function () {
            //     tableItem.ajax.url("{:url('/quality/common/datatablesPre')}?tableName=quality_division_controlpoint_relation&division_id="+divisionId+"&ma_division_id="+conThisId).load();
            // }
        });
    }

    //下载封装的方法
    function downloadFrom(id,url) {
        $.ajax({
            url: url,
            type:"post",
            dataType: "json",
            data:{formId:id},
            success: function (res) {
                if(res.code != 1){
                    layer.msg(res.msg);
                }else {
                    $("#form_container_from").empty();
                    var str = "";
                    str += ""
                        + "<iframe name=downloadFrame"+ id +" style='display:none;'></iframe>"
                        + "<form name=download"+id +" action="+ url +" method='get' target=downloadFrame"+ id + ">"
                        + "<span class='file_name' style='color: #000;'>"+str+"</span>"
                        + "<input class='file_url' style='display: none;' name='formId' value="+ id +">"
                        + "<button type='submit' class=btn" + id +"></button>"
                        + "</form>"
                    $("#form_container_from").append(str);
                    $("#form_container_from").find(".btn" + id).click();
                }
            }
        })
    }

    //在线填报-下载
    function downOnLine(id) {
        downloadFrom(id,"{:url('quality/element/formDownload')}")
        // console.log(id)
    }

    /*============在线填报结束==============*/

</script>
</html>
